<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-in — BTC</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f1724; --muted:#9aa4b2; --accent1:#f43f5e; --accent2:#fb923c; --text:#e6eef8; --input-bg: rgba(255,255,255,0.02); }
    html,body{height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);margin:0;}
    .wrap{max-width:760px;margin:48px auto;padding:36px;border-radius:14px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);}
    .it-icon{ width:68px;height:68px;border-radius:999px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;background: linear-gradient(180deg, rgba(244,63,94,0.12), rgba(251,146,60,0.08)); }
    h1{font-weight:900;text-align:center;margin:8px 0;font-size:34px}
    .muted{color:var(--muted);text-align:center;margin-bottom:16px}
    .label-upper{font-size:12px;color:var(--muted);font-weight:700;margin-bottom:6px;}
    .input-lg{height:56px;border-radius:10px;background:var(--input-bg);border:1px solid rgba(255,255,255,0.04);padding:14px;color:var(--text)}
    .btn-btc{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;height:56px;border-radius:12px;font-weight:800;box-shadow:0 10px 30px rgba(244,63,94,0.14)}
    .site-footer { position: fixed; left: 0; right: 0; bottom: 8px; text-align: center; font-size: 12px; color: #64748b; padding: 8px 0; pointer-events: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="text-align:center;">
      <div class="it-icon" aria-hidden="true">
        <svg width="34" height="34" viewBox="0 0 24 24" fill="none"><path d="M12 2l3 6 6 .5-4.5 4 1.5 6L12 16 5.5 19.5 7 13 2.5 9.5 9 9z" stroke="#fff" stroke-width="0.6"/></svg>
      </div>
      <h1>Check-in Ban Tổ Chức</h1>
      <p class="muted">Dành cho thành viên BTC nhận thẻ và số.<br><span class="small-pill">Đã tham gia: <span data-joined>0</span> / <span data-total>47</span></span></p>
    </div>

    <div class="mb-3">
      <label class="label-upper">Tên của bạn</label>
      <input id="btcName" class="form-control input-lg" placeholder="Tên thành viên BTC"/>
    </div>

    <div class="d-grid mb-2">
      <button id="btcConfirm" class="btn btn-btc">Xác Nhận BTC</button>
    </div>

    <div style="text-align:center;color:var(--muted);font-size:14px">Quay lại <a href="index.html" style="color:#cfe0ff">Check-in Khách mời</a></div>
  </div>

  <footer class="site-footer">© 2025 Eddy — Web Developer. 47 Slots System.</footer>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getFirestore, collection, doc, setDoc, serverTimestamp,
      onSnapshot, getDocs, getDoc
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAXtnsgM2cu7IdOOq5ZMPuNHpcUtTc_93g",
      authDomain: "it2025-c6ed8.firebaseapp.com",
      projectId: "it2025-c6ed8",
      storageBucket: "it2025-c6ed8.firebasestorage.app",
      messagingSenderId: "784468579580",
      appId: "1:784468579580:web:1b981ba6370aa7cf1b7379",
      measurementId: "G-ERVN4JE01P"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const attendeesCol = collection(db, 'attendees');

    const KEY = 'participants_v1';
    const TOTAL = 47;
    const BTC_LIMIT = 3;
    const TEAMS = Array.from({length:10}, (_,i)=>({id:i+1,capacity:i<6?4:5}));

    function loadAll(){ return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    function saveAll(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function setLastIndex(i){ localStorage.setItem('lastEntryIndex', String(i)); }
    function normalizeName(n){ return String(n||'').trim().toLowerCase(); }
    function countInTeam(arr, id){ return arr.filter(x=>x.team===id).length; }
    function assignTeam(arr){
      const left = {}; TEAMS.forEach(t=> left[t.id] = t.capacity - countInTeam(arr,t.id));
      const avail = Object.keys(left).filter(k=> left[k] > 0).map(Number);
      if(!avail.length) return null;
      const pool = [];
      avail.forEach(k=> { for(let i=0;i<left[k];i++) pool.push(k); });
      return pool[Math.floor(Math.random()*pool.length)];
    }
    function getRandomUnusedNumber(){
      const arr = loadAll();
      const used = new Set(arr.map(a=>Number(a.number)));
      const unused = [];
      for(let i=1;i<=TOTAL;i++) if(!used.has(i)) unused.push(i);
      if(!unused.length) return null;
      return unused[Math.floor(Math.random()*unused.length)];
    }
    function makeDocIdFrom(rec){
      const cleanName = rec.name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]+/g,"_").toLowerCase().slice(0,20);
      return `btc_${cleanName}_no${rec.number}`;
    }

    // realtime update total display
    function listenCounts(){
      onSnapshot(attendeesCol, (snap)=>{
        const totalCount = snap.size;
        document.querySelectorAll('[data-joined]').forEach(el=>el.textContent = totalCount);
        document.querySelectorAll('[data-total]').forEach(el=>el.textContent = TOTAL);

        // optional: show BTC-only count elsewhere if needed
        const docs = snap.docs.map(d=>d.data());
        const btcCount = docs.filter(d => String(d.role||'').toUpperCase() === 'BTC' || String(d.teamLabel||'').toUpperCase() === 'BTC').length;
        // you could show btcCount somewhere if you want
      }, (err)=>{ console.error('Lỗi onSnapshot BTC:', err); });
    }
    listenCounts();

    // ensureCanCheckIn like index
    async function ensureCanCheckIn(){
      const checked = localStorage.getItem('hasCheckedIn');
      const myDocId = localStorage.getItem('myDocId');
      if(checked !== '1') return true;
      if(!myDocId){ localStorage.removeItem('hasCheckedIn'); return true; }
      try{
        const snap = await getDoc(doc(db,'attendees', myDocId));
        if(snap.exists()){ window.location.href = 'result.html'; return false; }
        else { localStorage.removeItem('hasCheckedIn'); localStorage.removeItem('myDocId'); return true; }
      } catch(err){ console.error('Lỗi ensureCanCheckIn BTC:', err); return true; }
    }
    await ensureCanCheckIn();

    // UI
    const btcBtn = document.getElementById('btcConfirm');
    const btcName = document.getElementById('btcName');

    btcBtn.addEventListener('click', async ()=>{
      const name = btcName.value.trim();
      if(!name){ alert('Nhập tên thành viên BTC'); return; }

      const all = loadAll();
      if(all.some(p => normalizeName(p.name) === normalizeName(name))){ alert('Tên này đã tồn tại.'); return; }

      // check BTC count from Firestore
      try {
        const snapAll = await getDocs(attendeesCol);
        const docs = snapAll.docs.map(d => d.data());
        const btcCount = docs.filter(d => String(d.role||'').toUpperCase() === 'BTC' || String(d.teamLabel||'').toUpperCase() === 'BTC').length;
        if(btcCount >= BTC_LIMIT){ alert(`Số lượng BTC đã đủ (${btcCount}/${BTC_LIMIT})`); return; }
      } catch(err) {
        console.error('Lỗi đọc attendees (BTC):', err);
        alert('Lỗi kết nối Firestore. Thử lại sau.'); return;
      }

      // assign team & number
      const team = assignTeam(all);
      if(team === null){ alert('Tất cả team đều đầy.'); return; }
      const num = getRandomUnusedNumber();
      if(num === null){ alert('Không còn số trống.'); return; }

      const rec = { name, role:'BTC', teamLabel:'BTC', team, number:num, time:Date.now() };
      all.push(rec); saveAll(all); setLastIndex(all.length - 1);

      try {
        const docId = makeDocIdFrom(rec);
        const ref = doc(attendeesCol, docId);
        await setDoc(ref, {
          name: rec.name, role: rec.role, team: rec.team, teamLabel: rec.teamLabel,
          number: rec.number, createdAt: serverTimestamp()
        });

        localStorage.setItem('hasCheckedIn','1');
        localStorage.setItem('myDocId', docId);
        window.location.href = 'result.html';
      } catch(err) {
        console.error('Lỗi ghi Firestore (BTC):', err);
        alert('Không thể ghi dữ liệu. Vui lòng thử lại.');
      }
    });

    btcName.addEventListener('keypress', e=>{ if(e.key==='Enter') btcBtn.click(); });

  </script>

<footer class="site-footer">
  © 2025 Eddy – Web Developer. 47 Slots System.
</footer>
</body>
</html>




