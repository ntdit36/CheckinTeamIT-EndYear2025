<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Check-in Ban Tổ Chức (BTC)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#111827;--muted:#9aa4b2;--accent1:#f97316;--accent2:#ef4444;--input-bg:rgba(255,255,255,0.02);--text:#e6eef8;}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    body::before{content:"";position:fixed;inset:0;opacity:0.25;pointer-events:none;mix-blend-mode:screen}
    .wrap{max-width:760px;margin:48px auto;padding:36px;border-radius:14px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05)}
    .centerTop{text-align:center;margin-bottom:18px}
    h1{font-size:30px;font-weight:900;margin:10px 0}
    .sub{color:var(--muted);margin-bottom:12px}
    .input-large{height:56px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:var(--input-bg);padding:12px;color:white}
    .btn-btc{height:56px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white;font-weight:800}
    .small-muted{color:var(--muted);margin-top:10px;text-align:center}
    .site-footer{position:fixed;left:0;right:0;bottom:8px;text-align:center;font-size:12px;color:#64748b}
  </style>
</head>
<body>

  <div class="wrap">
    <div class="centerTop">
      <h1>Check-in Ban Tổ Chức</h1>
      <div class="sub">Dành cho thành viên BTC nhận số.</div>

      <div class="muted">
        Đã tham gia BTC:
        <span id="btcCount">0</span> / 3
      </div>
    </div>

    <div>
      <div class="mb-3">
        <label class="smallcaps">TÊN CỦA BẠN</label>
        <input id="btcName" class="form-control input-large" placeholder="Tên thành viên BTC" />
      </div>

      <div class="d-grid">
        <button id="btcConfirm" class="btn btn-btc">Xác Nhận BTC</button>
      </div>

      <a href="index.html" class="link-small d-block text-center mt-2" style="color:#9aa4b2;text-decoration:underline">Quay lại Check-in Khách</a>

      <div class="small-muted">Lưu ý: mục BTC tối đa <strong>3</strong> người.</div>
    </div>
  </div>


<!-- ====================== FIREBASE ====================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { 
  getFirestore, collection, query, orderBy,
  getDocs, setDoc, doc, serverTimestamp, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXtnsgM2cu7IdOOq5ZMPuNHpcUtTc_93g",
  authDomain: "it2025-c6ed8.firebaseapp.com",
  projectId: "it2025-c6ed8",
  storageBucket: "it2025-c6ed8.firebasestorage.app",
  messagingSenderId: "784468579580",
  appId: "1:784468579580:web:1b981ba6370aa7cf1b7379",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const attendeesCol = collection(db, "attendees");
const attendeesQuery = query(attendeesCol, orderBy("createdAt", "asc"));

const BTC_CAPACITY = 3;
const TOTAL = 44 + 3;
const KEY = "participants_v1";

let btcInput, btcBtn, btcCountEl;

// ====== Load DOM refs an toàn ======
document.addEventListener("DOMContentLoaded", () => {
  btcInput = document.getElementById("btcName");
  btcBtn   = document.getElementById("btcConfirm");
  btcCountEl = document.getElementById("btcCount");
});

// ====== AUTO UPDATE UI REALTIME ======
onSnapshot(attendeesQuery, (snap) => {
  const all = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  const btcNow = all.filter(p => (p.role || "").toUpperCase() === "BTC").length;

  if (btcCountEl) btcCountEl.textContent = btcNow;

  if (!btcBtn || !btcInput) return;

  if (btcNow >= BTC_CAPACITY) {
    btcInput.style.display = "none";
    btcBtn.disabled = true;
    btcBtn.textContent = "HẾT SLOT";
  } else {
    btcInput.style.display = "block";
    btcBtn.disabled = false;
    btcBtn.textContent = "Xác Nhận BTC";
  }

  // sync localStorage
  localStorage.setItem(KEY, JSON.stringify(all));
  localStorage.setItem("lastEntryIndex", String(Math.max(0, all.length - 1)));
});


// ====== SUBMIT BTC ======
document.addEventListener("click", async (e) => {
  if (e.target.id !== "btcConfirm") return;

  const name = btcInput.value.trim();
  if (!name) return alert("Nhập tên BTC.");

  // reload latest firestore
  const snap = await getDocs(attendeesQuery);
  const all = snap.docs.map(d => ({ id:d.id, ...d.data() }));

  const btcNow = all.filter(p => (p.role || "").toUpperCase() === "BTC").length;
  if (btcNow >= BTC_CAPACITY) return;

  // unique name check
  if (all.some(p => p.name && p.name.toLowerCase() === name.toLowerCase()))
    return alert("Tên này đã tồn tại.");

  // pick number
  const usedNums = new Set(all.map(p => Number(p.number)));
  const avail = [];
  for (let i = 1; i <= TOTAL; i++) if (!usedNums.has(i)) avail.push(i);

  const number = avail[Math.floor(Math.random() * avail.length)];

  const rec = {
    name,
    role: "BTC",
    team: null,
    teamLabel: "BTC",
    number,
    createdAt: serverTimestamp(),
  };

  const id = name.toLowerCase().replace(/[^a-z0-9]+/g, "_").slice(0,20) + `_btc${number}`;
  await setDoc(doc(attendeesCol, id), rec);

  // update local
  const local = JSON.parse(localStorage.getItem(KEY) || "[]");
  local.push(rec);
  localStorage.setItem(KEY, JSON.stringify(local));
  localStorage.setItem("lastEntryIndex", local.length - 1);

  window.location.href = "result.html";
});
</script>

<footer class="site-footer">
  © 2025 Eddy – Web Developer. 47 Slots System.
</footer>

</body>
</html>
