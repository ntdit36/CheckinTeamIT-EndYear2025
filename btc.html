<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Check-in Ban Tổ Chức (BTC)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#111827;--muted:#9aa4b2;--accent1:#f97316;--accent2:#ef4444;--card-bg: rgba(255,255,255,0.03);--input-bg: rgba(255,255,255,0.02);--text:#e6eef8;}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    body::before{content:"";position:fixed;inset:0;z-index:0;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="104" viewBox="0 0 120 104"><defs><pattern id="p" width="60" height="52" patternUnits="userSpaceOnUse"><path d="M30 0 L60 15 L60 37 L30 52 L0 37 L0 15 Z" fill="none" stroke="%234d5871" stroke-opacity="0.18" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23p)"/></svg>');opacity:0.28;mix-blend-mode:screen;pointer-events:none;transform:scale(1.03)}
    .wrap{position:relative;z-index:1;max-width:760px;margin:48px auto;padding:36px;border-radius:14px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04); box-shadow: 0 18px 40px rgba(3,7,18,0.55);}
    .centerTop{text-align:center;margin-bottom:18px}
    .centerTop h1{font-size:30px;font-weight:900;margin:6px 0}
    .centerTop .sub{color:var(--muted);margin-bottom:12px}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:700}
    .btc-card{margin-top:10px;padding:26px;border-radius:14px;background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.03);}
    label.smallcaps{font-size:12px;color:var(--muted);font-weight:700;letter-spacing:1px}
    .input-large{height:56px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:var(--input-bg);padding:12px;color:inherit}
    .btn-btc{height:56px;border-radius:12px;border:none;background: linear-gradient(90deg,var(--accent2),var(--accent1));color:white;font-weight:800}
    .link-small{display:block;text-align:center;color:var(--muted);margin-top:12px;text-decoration:underline;font-size:14px}
    .small-muted{color:var(--muted);font-size:13px;text-align:center;margin-top:10px}
    @media (max-width:520px){ .wrap{padding:20px} h1{font-size:26px} }
    .site-footer {
  position: fixed;         /* luôn dính cuối màn hình */
  left: 0;
  right: 0;
  bottom: 8px;
  text-align: center;
  font-size: 12px;
  color: #64748b;          /* tương đương text-slate-600 */
  padding: 16px 0;         /* tương đương p-4 */
  pointer-events: none;    /* để không che nút bấm phía trên */
}

  </style>
</head>
<body>
    

  <div class="wrap">
    <div class="centerTop">
      <div style="width:56px;height:56px;margin:0 auto;border-radius:999px;background:rgba(225,29,72,0.08);display:flex;align-items:center;justify-content:center">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 2l7 3v5c0 5-3.5 9.7-7 12-3.5-2.3-7-7-7-12V5l7-3z" stroke="#ef4444" stroke-width="1.2" fill="rgba(239,68,68,0.02)"/></svg>
      </div>

      <h1>Check-in Ban Tổ Chức</h1>
      <div class="sub">Dành cho thành viên BTC nhận thẻ và số.</div>
      <div class="muted">
  Đã tham gia BTC:
  <span data-btc-count>0</span> / 3
</div>

    </div>

    <div class="btc-card">
      <div class="mb-3">
        <label class="smallcaps">TÊN CỦA BẠN</label>
        <input id="btcName" class="form-control input-large" placeholder="Tên thành viên BTC" />
      </div>

      <div class="d-grid">
        <button id="btcConfirm" class="btn btn-btc">Xác Nhận BTC</button>
      </div>

      <a href="index.html" class="link-small">Quay lại Check-in Khách mới</a>

      <div class="small-muted">Lưu ý: mục BTC chỉ chấp nhận tối đa <strong>3</strong> người. Nếu đầy, liên hệ Eddy.</div>
    </div>
  </div>

<script type="module">
  // ============= IMPORT FIREBASE =============
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    // thay đổi: dùng onSnapshot để realtime
    onSnapshot,
    doc,
    updateDoc,
    deleteDoc,
    writeBatch
  } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

  // ============= CẤU HÌNH FIREBASE (GIỐNG INDEX) =============
  const firebaseConfig = {
    apiKey: "AIzaSyAXtnsgM2cu7IdOOq5ZMPuNHpcUtTc_93g",
    authDomain: "it2025-c6ed8.firebaseapp.com",
    projectId: "it2025-c6ed8",
    storageBucket: "it2025-c6ed8.firebasestorage.app",
    messagingSenderId: "784468579580",
    appId: "1:784468579580:web:1b981ba6370aa7cf1b7379",
    measurementId: "G-ERVN4JE01P"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const attendeesCol = collection(db, 'attendees');

  // ============= CẤU HÌNH GAME CỤC BỘ =============
  const KEY       = 'participants_v1';
  const IDX       = 'lastEntryIndex';
  const TOTAL     = 47;
  const BTC_LIMIT = 3;
  const TEAMS = Array.from({length:10}, (_,i)=>({id:i+1,capacity:i<6?4:5}));

  // ============= HÀM LOCALSTORAGE =============
  function loadAll(){ return JSON.parse(localStorage.getItem(KEY) || '[]'); }
  function saveAll(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
  function setLastIndex(i){ localStorage.setItem(IDX, String(i)); }
  function normalizeName(n){ return String(n||'').trim().toLowerCase(); }

  // ============= PHÂN TEAM + SỐ MAY MẮN =============
  function countInTeam(arr, id){ return arr.filter(x=>x.team===id).length; }

  function assignTeam(arr){
    const left = {};
    TEAMS.forEach(t=> left[t.id] = t.capacity - countInTeam(arr,t.id));
    const avail = Object.keys(left).filter(k=> left[k] > 0).map(Number);
    if(!avail.length) return null;
    const pool = [];
    avail.forEach(k=> { for(let i=0;i<left[k];i++) pool.push(k); });
    return pool[Math.floor(Math.random()*pool.length)];
  }

  function getRandomUnusedNumber(){
    const arr = loadAll();
    const used = new Set(arr.map(a=>Number(a.number)));
    const unused = [];
    for(let i=1;i<=TOTAL;i++) if(!used.has(i)) unused.push(i);
    if(!unused.length) return null;
    return unused[Math.floor(Math.random()*unused.length)];
  }

  // ============= LẤY BTC TRONG LOCAL (CHO GIỚI HẠN 3 NGƯỜI) =============
  function loadBTC(){
    const all = loadAll();
    return all.filter(item =>
      String(item.role || '').toUpperCase() === 'BTC' ||
      String(item.teamLabel || '').toUpperCase() === 'BTC'
    );
  }

  // ============= ID ĐẸP TRONG FIRESTORE =============
  function makeDocIdFrom(rec) {
    const cleanName = rec.name
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // bỏ dấu
      .replace(/[^a-zA-Z0-9]+/g, "_")                  // chỉ chữ/số/_
      .toLowerCase()
      .slice(0, 20);

    return `btc_${cleanName}_no${rec.number}`;
  }

  // ============= REALTIME ĐẾM BTC TỪ FIRESTORE =============
  function listenBTCCount() {
    onSnapshot(attendeesCol, (snap) => {
      const docs = snap.docs.map(d => d.data());
      const btcCount = docs.filter(d =>
        String(d.role || '').toUpperCase() === 'BTC' ||
        String(d.teamLabel || '').toUpperCase() === 'BTC'
      ).length;

      // gán vào mọi phần tử có data-btc-count
      document.querySelectorAll('[data-btc-count]').forEach(el => {
        el.textContent = btcCount;
      });

      // console.log('Realtime btcCount =', btcCount);
    }, (err) => {
      console.error('Lỗi onSnapshot BTC:', err);
    });
  }

  listenBTCCount();

  // ============= XỬ LÝ NÚT CHECK-IN BTC =============
  const btnBTC   = document.getElementById('btcConfirm');
  const nameBTC  = document.getElementById('btcName');

  if (!btnBTC || !nameBTC) {
    console.warn('Không tìm thấy #btcConfirm hoặc #btcName trong HTML.');
  } else {
    btnBTC.addEventListener('click', onBTCSubmit);
    nameBTC.addEventListener('keypress', e=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        onBTCSubmit();
      }
    });
  }

  async function onBTCSubmit(){
    const raw = nameBTC.value || '';
    const name = raw.trim();
    if(!name){
      alert('Nhập tên thành viên BTC.');
      return;
    }

    const all = loadAll();

    // chống trùng tên với bất kỳ ai
    if(all.some(p => normalizeName(p.name) === normalizeName(name))){
      alert('Tên này đã tồn tại trong danh sách.');
      return;
    }

    // giới hạn BTC theo local (3 người)
    const btcArr = loadBTC();
    if(btcArr.length >= BTC_LIMIT){
      alert('Số lượng BTC đã đủ (3 người).');
      return;
    }

    // phân team + số (BTC vẫn chiếm slot & số như khách)
    const team = assignTeam(all);
    if(team === null){
      alert('Tất cả team đều đầy.');
      return;
    }

    const num = getRandomUnusedNumber();
    if(num === null){
      alert('Không còn số trống.');
      return;
    }

    const rec = {
      name,
      role: 'BTC',
      teamLabel: 'BTC',
      team,
      number: num,
      time: Date.now()
    };

    // 1) Lưu localStorage (cho result/admin cũ dùng)
    all.push(rec);
    saveAll(all);
    setLastIndex(all.length - 1);

    // 2) Ghi Firestore
    try {
      const docId = makeDocIdFrom(rec);
      const ref   = doc(attendeesCol, docId);
      await setDoc(ref, {
        name: rec.name,
        role: rec.role,
        team: rec.team,
        teamLabel: rec.teamLabel,
        number: rec.number,
        createdAt: serverTimestamp()
      });
    } catch (err) {
      console.error('Lỗi Firestore BTC:', err);
    }

    // 3) Chuyển sang trang kết quả
    window.location.href = 'result.html';
  }
</script>


<footer class="site-footer">
  © 2025 Eddy – Web Developer. 47 Slots System.
</footer>
</body>
</html>




