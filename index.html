<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-in — Public</title>

  <!-- Bootstrap optional -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;
      --muted:#9aa4b2;
      --accent1:#5b4df7;
      --accent2:#9b5cf6;
      --card-bg: rgba(255,255,255,0.03);
      --input-bg: rgba(255,255,255,0.02);
      --text:#e6eef8;
    }
    html,body{height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);margin:0;}
    body::before{content:"";position:fixed;inset:0;opacity:0.22;pointer-events:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="104" viewBox="0 0 120 104"><defs><pattern id="p" width="60" height="52" patternUnits="userSpaceOnUse"><path d="M30 0 L60 15 L60 37 L30 52 L0 37 L0 15 Z" fill="none" stroke="%234d5871" stroke-opacity="0.14" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23p)"/></svg>');transform:scale(1.03);mix-blend-mode:screen;}
    .wrap{position:relative;z-index:1;max-width:760px;margin:48px auto;padding:36px;border-radius:14px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04); box-shadow: 0 18px 40px rgba(3,7,18,0.55);}
    .titleTop{ text-align:center; margin-bottom:8px; }
    .it-icon{ width:68px;height:68px;border-radius:999px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;background: linear-gradient(180deg, rgba(91,77,247,0.14), rgba(155,92,246,0.08)); border:1px solid rgba(255,255,255,0.03); box-shadow: 0 8px 28px rgba(91,77,247,0.12); }
    h1{font-weight:900;text-align:center;margin:8px 0;font-size:34px;letter-spacing:0.8px}
    .muted{color:var(--muted);text-align:center;margin-bottom:16px}
    .small-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:600;color:var(--muted)}
    .label-upper{font-size:12px;color:var(--muted);font-weight:700;letter-spacing:1px;margin-bottom:6px;}
    .input-lg{height:56px;border-radius:10px;background:var(--input-bg);border:1px solid rgba(255,255,255,0.04);padding:14px;color:var(--text)}
    .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;height:56px;border-radius:12px;font-weight:800;box-shadow:0 10px 30px rgba(91,77,247,0.16)}
    .admin-link{display:block;text-align:center;color:var(--muted);margin-top:14px;text-decoration:underline;font-size:14px}
    .gear-btn{position:fixed; right:18px; top:18px; z-index:999; width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.025); border:1px solid rgba(255,255,255,0.04); cursor:pointer; box-shadow: 0 6px 18px rgba(2,6,23,0.5);}
    .site-footer { position: fixed; left: 0; right: 0; bottom: 8px; text-align: center; font-size: 12px; color: #64748b; padding: 8px 0; pointer-events: none; }
    @media (max-width:520px){ .wrap{padding:20px} h1{font-size:26px} .it-icon{width:56px;height:56px} }
  </style>
</head>
<body>
  <a class="gear-btn" href="admin.html" title="Xem trang Admin" onclick="requireAdmin(event)">
    <!-- gear icon -->
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#cfe0ff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06"/></svg>
  </a>

  <div class="wrap">
    <div class="titleTop">
      <div class="it-icon" aria-hidden="true">
        <svg width="34" height="34" viewBox="0 0 24 24" fill="none"><rect x="2.5" y="4" width="19" height="12" rx="1.5" stroke="#e6eef8" stroke-width="1.2" fill="rgba(255,255,255,0.02)"/></svg>
      </div>
      <h1>CHECK-IN NHẬN QUÀ</h1>
    </div>

    <div class="muted">
      Nhập tên để nhận số thứ tự và team ngẫu nhiên. <br>
      <span class="small-pill"> Đã tham gia: <span data-joined>0</span> / <span data-total>47</span></span>
    </div>

    <div style="height:10px"></div>

    <div class="mb-3">
      <label class="label-upper">Tên thành viên</label>
      <input id="nameInput" class="form-control input-lg" placeholder="Ví dụ: Nguyễn Văn A"/>
    </div>

    <div class="d-grid mb-2">
      <button id="checkBtn" class="btn btn-primary">Xác nhận</button>
    </div>

    <div class="text-center">
      <a id="btcLink" href="btc.html" class="admin-link">Check-in dành cho Ban Tổ Chức (Eddy)</a>
    </div>
  </div>

  <footer class="site-footer">© 2025 Eddy — Web Developer. 47 Slots System.</footer>

  <!-- ===== SCRIPT (module) ===== -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getFirestore, collection, doc, setDoc, serverTimestamp,
      onSnapshot, getDocs, getDoc
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // ====== cấu hình Firebase: đổi thành config của bạn nếu khác ======
    const firebaseConfig = {
      apiKey: "AIzaSyAXtnsgM2cu7IdOOq5ZMPuNHpcUtTc_93g",
      authDomain: "it2025-c6ed8.firebaseapp.com",
      projectId: "it2025-c6ed8",
      storageBucket: "it2025-c6ed8.firebasestorage.app",
      messagingSenderId: "784468579580",
      appId: "1:784468579580:web:1b981ba6370aa7cf1b7379",
      measurementId: "G-ERVN4JE01P"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const attendeesCol = collection(db, 'attendees');

    // ========== config app ==========
    const KEY   = 'participants_v1';
    const IDX   = 'lastEntryIndex';
    const TOTAL = 47;
    const TEAMS = Array.from({length:10}, (_,i)=>({id:i+1,capacity:i<6?4:5}));

    // ========== helpers local ==========
    function loadAll(){ return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    function saveAll(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function setLastIndex(i){ localStorage.setItem(IDX, String(i)); }
    function normalizeName(n){ return String(n||'').trim().toLowerCase(); }
    function countInTeam(arr, id){ return arr.filter(x=>x.team===id).length; }

    function assignTeam(arr){
      const left = {}; TEAMS.forEach(t=> left[t.id] = t.capacity - countInTeam(arr,t.id));
      const avail = Object.keys(left).filter(k=> left[k] > 0).map(Number);
      if(!avail.length) return null;
      const pool = [];
      avail.forEach(k=> { for(let i=0;i<left[k];i++) pool.push(k); });
      return pool[Math.floor(Math.random()*pool.length)];
    }

    function getRandomUnusedNumber(){
      const arr = loadAll();
      const used = new Set(arr.map(a=>Number(a.number)));
      const unused = [];
      for(let i=1;i<=TOTAL;i++) if(!used.has(i)) unused.push(i);
      if(!unused.length) return null;
      return unused[Math.floor(Math.random()*unused.length)];
    }

    function makeDocIdFrom(rec) {
      const cleanName = rec.name
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9]+/g, "_")
        .toLowerCase()
        .slice(0, 20);
      return `${cleanName}_team${rec.team}_no${rec.number}`;
    }

    // ========== realtime: cập nhật tổng (bao gồm BTC) ==========
    function listenJoinedCount() {
      onSnapshot(attendeesCol, (snap) => {
        const totalCount = snap.size;
        document.querySelectorAll('[data-joined]').forEach(el => el.textContent = totalCount);
        document.querySelectorAll('[data-total]').forEach(el => el.textContent = TOTAL);
      }, (err) => {
        console.error('Lỗi onSnapshot index:', err);
      });
    }
    listenJoinedCount();

    // ========== ensureCanCheckIn (lưu myDocId + unlock khi admin xóa) ==========
    async function ensureCanCheckIn() {
      const checked = localStorage.getItem('hasCheckedIn');
      const myDocId = localStorage.getItem('myDocId');
      if (checked !== '1') return true;
      if (!myDocId) {
        localStorage.removeItem('hasCheckedIn');
        return true;
      }
      try {
        const snap = await getDoc(doc(db,'attendees', myDocId));
        if (snap.exists()) {
          // redirect to result (user already checked)
          window.location.href = 'result.html';
          return false;
        } else {
          localStorage.removeItem('hasCheckedIn');
          localStorage.removeItem('myDocId');
          return true;
        }
      } catch (err) {
        console.error('Lỗi ensureCanCheckIn:', err);
        return true;
      }
    }

    await ensureCanCheckIn();

    // ========== UI bindings ==========
    const btn = document.getElementById('checkBtn');
    const nameInput = document.getElementById('nameInput');

    btn.addEventListener('click', async ()=>{
      const name = nameInput.value.trim();
      if(!name){ alert('Vui lòng nhập tên.'); return; }

      const all = loadAll();
      if(all.some(p => normalizeName(p.name) === normalizeName(name))){
        alert('Tên này đã tồn tại.'); return;
      }

      // Check Firestore total (bao gồm BTC)
      try {
        const snapAll = await getDocs(attendeesCol);
        const currentTotal = snapAll.size;
        if (currentTotal >= TOTAL) {
          alert(`Đã đủ ${TOTAL} người tham gia. Không thể đăng ký thêm.`);
          return;
        }
      } catch (err) {
        console.error('Lỗi đọc attendees:', err);
        alert('Lỗi kết nối Firestore. Thử lại sau.');
        return;
      }

      // assign team + number
      const team = assignTeam(all);
      if(team === null){ alert('Tất cả team đều đầy.'); return; }
      const num = getRandomUnusedNumber();
      if(num === null){ alert('Không còn số trống.'); return; }

      const rec = { name, team, number: num, time: Date.now(), teamLabel: 'TEAM ' + team, role: 'GUEST' };

      // save local first
      all.push(rec); saveAll(all); setLastIndex(all.length - 1);

      // write to Firestore
      try {
        const docId = makeDocIdFrom(rec);
        const ref = doc(attendeesCol, docId);
        await setDoc(ref, {
          name: rec.name, team: rec.team, teamLabel: rec.teamLabel,
          number: rec.number, role: rec.role, createdAt: serverTimestamp()
        });

        // lock client
        localStorage.setItem('hasCheckedIn','1');
        localStorage.setItem('myDocId', docId);

        window.location.href = 'result.html';
      } catch (err) {
        console.error('Lỗi ghi Firestore:', err);
        alert('Không thể ghi dữ liệu. Vui lòng thử lại.');
      }
    });

    nameInput.addEventListener('keypress', e=>{ if(e.key==='Enter') btn.click(); });

    // requireAdmin helper (for gear link)
    window.requireAdmin = function(e){
      if(e && e.preventDefault) e.preventDefault();
      if(sessionStorage.getItem('admin_auth')==='1'){ window.location.href='admin.html'; return; }
      const pw = prompt('Nhập mật khẩu Admin để xem trang Quản lý:');
      if(pw===null) return;
      if(pw==='admin2025'){ sessionStorage.setItem('admin_auth','1'); window.location.href='admin.html'; }
      else alert('Mật khẩu không đúng.');
    };
  </script>
  <footer class="site-footer">
  © 2025 Eddy – Web Developer. 47 Slots System.
</footer>
</body>
</html>
