<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Check-in — IT TEAMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#111827;
      --muted:#9aa4b2;
      --accent1:#5b4df7;
      --accent2:#9b5cf6;
      --card-bg: rgba(255,255,255,0.03);
      --input-bg: rgb(136, 136, 136);
      --text:#e6eef8;
    }
    html,body{height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);margin:0;}
    body::before{content:"";position:fixed;inset:0;opacity:0.28;pointer-events:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="104" viewBox="0 0 120 104"><defs><pattern id="p" width="60" height="52" patternUnits="userSpaceOnUse"><path d="M30 0 L60 15 L60 37 L30 52 L0 37 L0 15 Z" fill="none" stroke="%234d5871" stroke-opacity="0.18" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23p)"/></svg>');transform:scale(1.03);mix-blend-mode:screen;}
    .wrap{position:relative;z-index:1;max-width:760px;margin:48px auto;padding:36px;border-radius:14px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04); box-shadow: 0 18px 40px rgba(3,7,18,0.55);}
    .titleTop{ text-align:center; margin-bottom:8px; }
    .it-icon{ width:68px;height:68px;border-radius:999px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;background: linear-gradient(180deg, rgba(91,77,247,0.14), rgba(155,92,246,0.08)); border:1px solid rgba(255,255,255,0.03); box-shadow: 0 8px 28px rgba(91,77,247,0.12); }
    h1{font-weight:900;text-align:center;margin:8px 0;font-size:34px;letter-spacing:0.8px}
    .muted{color:var(--muted);text-align:center;margin-bottom:16px}
    .small-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(238, 181, 25, 0.03);font-weight:600;color:var(--muted)}
    .label-upper{font-size:12px;color:var(--muted);font-weight:700;letter-spacing:1px;margin-bottom:6px;}
    .input-lg{height:56px;border-radius:10px;background:var(--input-bg);border:1px solid rgba(255,255,255,0.04);padding:14px;color:var(--text)}
    .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;height:56px;border-radius:12px;font-weight:800;box-shadow:0 10px 30px rgba(91,77,247,0.16)}
    .admin-link{display:block;text-align:center;color:var(--muted);margin-top:14px;text-decoration:underline;font-size:14px}
    .gear-btn{position:fixed; right:18px; top:18px; z-index:999; width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.025); border:1px solid rgba(255,255,255,0.04); cursor:pointer; box-shadow: 0 6px 18px rgba(2,6,23,0.5);}
    @media (max-width:520px){ .wrap{padding:20px} h1{font-size:26px} .it-icon{width:56px;height:56px} }
    .site-footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 8px;
      text-align: center;
      font-size: 12px;
      color: #64748b;
      padding: 16px 0;
      pointer-events: none;
    }
    .it-icon{
  width:86px;
  height:86px;
  border-radius:999px;
  margin:0 auto 10px;
  display:flex;
  align-items:center;
  justify-content:center;

  /* remove outer visuals */
  background: transparent;     /* no gradient */
  border: none;                /* no border */
  box-shadow: none;            /* no shadow */

  overflow: hidden;            /* giữ logo không tràn vùng tròn */
  padding: 6px;                /* optional: tạo khoảng thở quanh logo */
}

/* logo vừa vặn trong vòng tròn */
.it-icon .logo-img{
  width: 100%;
  height: 100%;
  object-fit: contain; /* giữ tỉ lệ, không crop méo */
  display:block;
}


  </style>
</head>
<body>

  <a class="gear-btn" href="admin.html" title="Xem trang Admin" onclick="return requireAdmin(event)">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#cfe0ff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 0 1 6.57 2.1l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09c0 .6.39 1.16 1 1.51h.55a1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 0 1 20.94 6.6l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .6.39 1.16 1 1.51H21a2 2 0 0 1 0 4h-.09c-.6 0-1.16.39-1.51 1z"/></svg>
  </a>

  <div class="wrap">
    <div class="titleTop">
      <div class="it-icon" aria-hidden="true">
  <img src="./logoIT.png"
       alt="Logo IT"
       class="logo-img" loading="lazy">
        
          <rect x="2.5" y="4" width="19" height="12" rx="1.5" stroke="#e6eef8" stroke-width="1.2" fill="rgba(255,255,255,0.02)"/>
          <path d="M3 16.6h18" stroke="#cfe0ff" stroke-width="1.1" stroke-linecap="round"/>
          <path d="M8 8.8h1.8" stroke="#cfe0ff" stroke-width="1.3" stroke-linecap="round"/>
          <path d="M10.2 11.2h3.6" stroke="#cfe0ff" stroke-width="1.3" stroke-linecap="round"/>
          <rect x="7" y="17.4" width="10" height="1.2" rx="0.6" fill="#cfe0ff" opacity="0.06"/>
        </svg>
      </div>
      <h1>CHECK-IN IT TEAM</h1>
    </div>

    <div class="muted">Nhập tên để nhận số thứ tự và team. <br> <span class="small-pill">Đã tham gia: <span id="joined">0</span>/ <span id="total">44</span></span></div>

    <div style="height:10px"></div>

    <div class="mb-3">
      <label class="label-upper">Tên thành viên</label>
      <input id="nameInput" class="form-control input-lg" placeholder="Ví dụ: Eddy"/>
    </div>

    <div class="d-grid mb-2">
      <button id="checkBtn" class="btn btn-primary">Xác nhận</button>
    </div>

    <div class="text-center">
      <a id="btcLink" href="btc.html" class="admin-link">Check-in dành cho Ban Tổ Chức</a>
    </div>
  </div>

<script type="module">
  // Firebase + logic (transaction-safe)
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
  import {
    getFirestore,
    collection,
    doc,
    query,
    orderBy,
    onSnapshot,
    runTransaction,
    serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyAXtnsgM2cu7IdOOq5ZMPuNHpcUtTc_93g",
    authDomain: "it2025-c6ed8.firebaseapp.com",
    projectId: "it2025-c6ed8",
    storageBucket: "it2025-c6ed8.firebasestorage.app",
    messagingSenderId: "784468579580",
    appId: "1:784468579580:web:1b981ba6370aa7cf1b7379",
    measurementId: "G-ERVN4JE01P"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const attendeesCol = collection(db, 'attendees');
  const attendeesQuery = query(attendeesCol, orderBy('createdAt','asc'));

  // Config
  const GUEST_TOTAL = 44;
  const BTC_CAPACITY = 3;
  const TOTAL = GUEST_TOTAL + BTC_CAPACITY; // 47
  const KEY = 'participants_v1';
  const IDX = 'lastEntryIndex';
  const TEAMS = Array.from({length:10}, (_,i)=>({id:i+1,capacity:i<6?4:5}));

  // UI refs
  const joinedEl = document.getElementById('joined');
  const totalEl = document.getElementById('total');
  const btn = document.getElementById('checkBtn');
  const nameInput = document.getElementById('nameInput');

  // util localStorage
  function loadAll(){ try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch(e){ return []; } }
  function saveAll(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
  function setLastIndex(i){ localStorage.setItem(IDX, String(i)); }
  function normalizeName(n){ return String(n||'').trim().toLowerCase(); }

  // build id
  function makeDocIdFrom(rec){
    const cleanName = rec.name
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-zA-Z0-9]+/g, "_")
      .toLowerCase()
      .slice(0,20);
    return `${cleanName}_team${rec.team}_no${rec.number}`;
  }

  // update counts from local
  function updateCountsFromLocal() {
    const all = loadAll() || [];
    const guestCount = all.filter(p => {
      const r = String(p.role || 'GUEST').toUpperCase();
      return r !== 'BTC';
    }).length;
    joinedEl.textContent = guestCount;
    totalEl.textContent = GUEST_TOTAL;
  }
  updateCountsFromLocal();
  window.addEventListener('storage', (e)=>{ if(e.key === KEY) updateCountsFromLocal(); });

  // realtime listener to sync UI and localStorage safely
  onSnapshot(attendeesQuery, (snap) => {
    const remote = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    // guest count shown to users
    const guestCount = remote.filter(p => String(p.role||'').toUpperCase() !== 'BTC').length;
    joinedEl.textContent = guestCount;
    totalEl.textContent = GUEST_TOTAL;
    // disable button if full
    btn.disabled = (guestCount >= GUEST_TOTAL);

    // sync localStorage but avoid overwriting local when remote is temporarily empty
    try {
      const dump = remote.map(p => ({
        name: p.name || '',
        number: p.number || null,
        role: p.role || '',
        team: p.team || null,
        teamLabel: p.teamLabel || '',
        slogan: p.slogan || '',
        createdAt: p.createdAt ? (p.createdAt.toDate ? p.createdAt.toDate().toISOString() : new Date(p.createdAt).toISOString()) : null
      }));
      const localRaw = localStorage.getItem(KEY);
      const localArr = localRaw ? JSON.parse(localRaw) : [];
      if (!(dump.length === 0 && localArr.length > 0)) {
        localStorage.setItem(KEY, JSON.stringify(dump));
        localStorage.setItem(IDX, String(Math.max(0, dump.length - 1)));
      }
    } catch(e){ console.warn(e); }
  }, (err) => {
    console.error('Realtime listener error:', err);
  });

  // helper compute available from remote (not used in transaction path but kept)
  function computeAvailableFromServer(serverDocs){
    const usedNumbers = new Set(serverDocs.map(s => Number(s.number)).filter(n => !isNaN(n)));
    const availNumbers = [];
    for(let i=1;i<=TOTAL;i++) if(!usedNumbers.has(i)) availNumbers.push(i);
    const teamLeft = {};
    TEAMS.forEach(t => {
      const usedByGuests = serverDocs.filter(p => (String(p.role||'').toUpperCase() !== 'BTC') && Number(p.team) === t.id).length;
      teamLeft[t.id] = Math.max(0, t.capacity - usedByGuests);
    });
    return { availNumbers, teamLeft };
  }

  // ---------- TRANSACTION-BASED SUBMIT ----------
  btn.addEventListener('click', async ()=>{
    const name = nameInput.value.trim();
    if(!name){ alert('Vui lòng nhập tên.'); return; }

    btn.disabled = true;
    try {
      const newRec = await runTransaction(db, async (tx) => {
        // read snapshot atomically
        const snap = await tx.get(attendeesQuery);
        const serverDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        // duplicate name on server?
        if(serverDocs.some(p => normalizeName(p.name) === normalizeName(name))){
          throw new Error('DUP_NAME');
        }

        // guest count (exclude BTC)
        const guestNow = serverDocs.filter(p => String(p.role||'').toUpperCase() !== 'BTC').length;
        if(guestNow >= GUEST_TOTAL){
          throw new Error('GUEST_FULL');
        }

        // used numbers (both BTC & guests)
        const usedNumbers = new Set(serverDocs.map(s => Number(s.number)).filter(n => !isNaN(n)));
        const availNumbers = [];
        for(let i=1;i<=TOTAL;i++) if(!usedNumbers.has(i)) availNumbers.push(i);
        if(availNumbers.length === 0) throw new Error('NO_NUMBER');

        // compute teamLeft counting only guests (BTC ignored)
        const teamLeft = {};
        TEAMS.forEach(t => {
          const usedByGuests = serverDocs.filter(p => String(p.role||'').toUpperCase() !== 'BTC' && Number(p.team) === t.id).length;
          teamLeft[t.id] = Math.max(0, t.capacity - usedByGuests);
        });
        const pool = [];
        Object.keys(teamLeft).forEach(k => { for(let i=0;i<teamLeft[k];i++) pool.push(Number(k)); });
        if(pool.length === 0) throw new Error('TEAMS_FULL');

        // choose number & team
        const chosenNumber = availNumbers[Math.floor(Math.random()*availNumbers.length)];
        const chosenTeam = pool[Math.floor(Math.random()*pool.length)];

        const rec = {
          name,
          team: chosenTeam,
          number: chosenNumber,
          time: Date.now(),
          teamLabel: 'TEAM ' + chosenTeam,
          role: 'GUEST',
          createdAt: serverTimestamp()
        };

        // pick unique doc id
        let docId = makeDocIdFrom(rec);
        let docRef = doc(attendeesCol, docId);
        let suffix = 0;
        while (serverDocs.some(d => d.id === docId)) {
          suffix++;
          docId = `${docId}_${suffix}`;
          docRef = doc(attendeesCol, docId);
        }

        tx.set(docRef, rec);
        return rec;
      }, { maxAttempts: 5 });

      // success: save locally and navigate
      try {
        const a = loadAll();
        a.push(newRec);
        saveAll(a);
        setLastIndex(a.length - 1);
        updateCountsFromLocal();
      } catch(e){ console.warn('local save failed', e); }

      window.location.href = 'result.html';
    } catch (err) {
      console.error('Transaction failed:', err);
      if(err.message === 'DUP_NAME') alert('Tên này đã tồn tại. Vui lòng dùng tên khác.');
      else if(err.message === 'GUEST_FULL') alert('Đã đầy cho khách (44).');
      else if(err.message === 'NO_NUMBER') alert('Không còn số trống.');
      else if(err.message === 'TEAMS_FULL') alert('Tất cả team đã đầy cho khách.');
      else alert('Ghi không thành công. Thử lại (mạng/phiên).');
    } finally {
      btn.disabled = false;
    }
  });

  nameInput.addEventListener('keypress', e=>{ if(e.key==='Enter') btn.click(); });

  // admin require guard
  function requireAdmin(e){
    return true; // allow link; admin page itself prompts for password
  }
  window.requireAdmin = requireAdmin;

</script>

<footer class="site-footer">
  © 2025 Eddy – Web Developer. 47 Slots System.
</footer>

</body>
</html>